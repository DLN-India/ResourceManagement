@using Fritz.ResourceManagement.Domain
@using Microsoft.EntityFrameworkCore
@inject System.Security.Claims.ClaimsPrincipal CurrentUser
@inject Models.MyDbContext DbContext
@inject Data.ScheduleState MyScheduleState

<div id="Availability" style="display: inline-block; vertical-align: top;">

	<h3>Set the availability for @CurrentUser.Identity.Name</h3>

	<div class="row">

		<div class="col-md-4">
			<h4>Scheduled Appointments</h4>

			<p>
				<input type="text" name="Name" bind="@NewScheduleItem.Name" placeholder="Name of the Appointment" />
				<input type="datetime" name="StartTime" bind="@NewScheduleItem.StartDateTime" placeholder="Start Date and Time" />
				<input type="datetime" name="EndTime" bind="@NewScheduleItem.EndDateTime" placeholder="End Date and Time" />
			</p>
			<button onclick="@(() => AddNewScheduleItem())">Add New Schedule Item</button>

			<ul>
				@foreach (var scheduleItem in MySchedule?.ScheduleItems)
				{
					<li>@scheduleItem.Name :: @scheduleItem.StartDateTime - @scheduleItem.EndDateTime</li>
				}
			</ul>

		</div>

	</div>

</div>

<div id="MySchedule" style="display: inline-block">
	<h3>My Schedule</h3>

	<CascadingValue Value="MySchedule" Name="MySchedule">
		<CascadingValue Value="SelectedDate" Name="SelectedDate">
			<DayPicker />

			<DayView />
		</CascadingValue>
	</CascadingValue>
</div>




@functions {

	// Cheer 500 electrichavoc 07/06/19

	Schedule MySchedule { get; set; } = null;

	DateTime SelectedDate { get; set; } = DateTime.Today;

	ScheduleItem NewScheduleItem;

	protected override void OnInit()
	{
		ResetScheduleItem();
		MySchedule = GetMyAvailability();

		MyScheduleState.SelectDate(SelectedDate);
		MyScheduleState.Schedule = MySchedule;

	}


	Schedule GetMyAvailability()
	{

		var personId = CurrentUser.GetPersonId();

		var thisPerson = DbContext
			.Persons
			.Include(p => p.Schedule)
			.ThenInclude(s => s.ScheduleItems)
			.First(p => p.Id == personId);

		return thisPerson.Schedule;

	}

	void AddNewScheduleItem()
	{

		// Cheer 200 ultramark 07/06/19
		// Cheer 100 TheMichaelJolley 07/06/19

		NewScheduleItem.Status = ScheduleStatus.NotAvailable;
		NewScheduleItem.ScheduleId = MySchedule.Id;

		DbContext.Schedules.Update(MySchedule);
		MySchedule.ScheduleItems.Add(NewScheduleItem);
		DbContext.SaveChanges();

		MyScheduleState.ScheduleUpdated();

		ResetScheduleItem();

	}

	void ResetScheduleItem()
	{

		NewScheduleItem = new ScheduleItem();
		NewScheduleItem.StartDateTime = DateTime.Today;
		NewScheduleItem.EndDateTime = DateTime.Today.AddDays(1);


	}

	protected override void OnParametersSet()
	{
		base.OnParametersSet();
	}

}
